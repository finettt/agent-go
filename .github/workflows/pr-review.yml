name: Claude Code Agent

on:
  issue_comment:
    types: [created]

jobs:
  claude-code:
    if: github.event_name == 'issue_comment' && contains(github.event.comment.body, '@claude')
    runs-on: ubuntu-latest
    permissions:
      contents: write
      pull-requests: write
      issues: read
      id-token: write

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup Bun (Required for Router)
        uses: oven-sh/setup-bun@v1
        with:
          bun-version: latest

      - name: Configure Claude Code Router
        run: |
          mkdir -p $HOME/.claude-code-router
          cat << 'EOF' > $HOME/.claude-code-router/config.json
          {
            "log": true,
            "NON_INTERACTIVE_MODE": true,
            "OPENAI_API_KEY": "${{ secrets.API_KEY }}",
            "OPENAI_BASE_URL": "${{ secrets.API_URL }}",
            "OPENAI_MODEL": "${{ secrets.MODEL }}"
          }
          EOF
        shell: bash

      - name: Start Claude Code Router
        run: |
          # Start the router in the background
          nohup bunx @musistudio/claude-code-router@1.0.8 start > router.log 2>&1 &
          
          # Wait a few seconds to ensure the server is up
          sleep 5
          echo "Router started on port 3456"
        shell: bash

      - name: Run Claude Code Action
        uses: anthropics/claude-code-action@beta
        env:
          ANTHROPIC_BASE_URL: http://localhost:3456
        with:
          anthropic_api_key: "dummy-key-routed-locally"
          prompt: "${{ github.event.comment.body }}"